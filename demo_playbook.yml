---
- name: Dynamic inventory
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Create a dynamic inventory
      add_host:
        hostname: chkp_mgmt_srv
        ansible_host: "{{ target }}" # run the play boot with -e "target=x.x.x.x" where x.x.x.x is the IP of your management server
        # Credentials for cp_mgmt* modules and Settings for the Check Point httpapi plugin that provides methods to connect to Checkpoint devices over a HTTP(S)-based api.
        ansible_httpapi_use_ssl: True
        ansible_httpapi_validate_certs: False
        ansible_network_os: check_point.mgmt.checkpoint #Using Galaxy https://galaxy.ansible.com/check_point collection
        ansible_checkpoint_domain: SMC User # Default domain for a SMS (SmartCenter)
        ansible_user: api_user # Change to your Check Point management admin user
        ansible_ssh_pass: vpn123 # Change to your Check Point management admin password
        #ansible_api_key: xxxxxxxxxx # Optionally you can use API key instead of username and password

- name: Build Ansible demo policy automation_policy on Check Point management server {{ target }}
  hosts: chkp_mgmt_srv
  connection: httpapi
  gather_facts: no
  tasks:

    - name: Add or delete policy package
      check_point.mgmt.cp_mgmt_package:
        state: present
        access: true
        color: blue
        comments: Policy automated through ansible and versioned in Git
        name: automation_policy
        threat_prevention: true

    - name: Add, set or delete Check Point host object
      check_point.mgmt.cp_mgmt_host:
        state: present
        name: Mail server
        ip_address: 192.168.1.1
        color: red
        comments: my mail server host objects

    - name: Add, set or delete Check Point host object
      check_point.mgmt.cp_mgmt_host:
        state: present
        name: Web server
        ip_address: 10.1.1.55
        color: yellow
        comments: my blue jump host object

    - name: Add, set or delete Check Point host object
      check_point.mgmt.cp_mgmt_host:
        state: present
        name: DB server
        ip_address: 10.1.2.55
        color: red
        comments: my ubuntu host object

    - name: add-group, set or delete Check Point group object
      check_point.mgmt.cp_mgmt_group:
        state: present
        name: Ansible control node group
        color: forest green

    - name: add, set, or delete Check Point access rule
      check_point.mgmt.cp_mgmt_access_rule:
        state: present
        layer: automation_policy Network
        name: allow access from ansible control node
        position: 1
        source: Ansible control node group
        destination:
        - Web server
        - Mail server
        service:
        - http
        - https
        - ssh
        action: Accept
        track:
          type: log

    - name: add, set, or delete Check Point access rule
      check_point.mgmt.cp_mgmt_access_rule:
        state: present
        layer: automation_policy Network
        name: allow SMTP access from any where
        position: 2
        destination:
        - mail server
        service:
        - smtp
        action: Accept
        track:
          type: log

    - name: present
      cp_mgmt_publish:
